===============================================
SÃœRÃœCÃœ-KULLANICI EÅLEÅTÄ°RME SÄ°STEMÄ° KULLANIM REHBERÄ°
TakiWebApi - Driver-User Matching System Usage Guide
===============================================

Bu rehber, yeni geliÅŸtirilen eÅŸleÅŸtirme sisteminin nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± adÄ±m adÄ±m aÃ§Ä±klamaktadÄ±r.

===============================================
1. SÄ°STEM KURULUMU VE BAÅLATMA
===============================================

ğŸ—„ï¸ VERÄ°TABANI KURULUMU:
------------------------
1. SQL Server Management Studio'yu aÃ§Ä±n
2. TaxiDb veritabanÄ±na baÄŸlanÄ±n
3. CreateMatchingTables.sql dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n:

```sql
-- Dosya konumu: /TakiWebApi/CreateMatchingTables.sql
USE TaxiDb;
-- Script'i tamamen Ã§alÄ±ÅŸtÄ±rÄ±n
```

4. BaÅŸarÄ±lÄ± kurulum mesajÄ±nÄ± kontrol edin:
```
âœ… Matching system database tables created successfully!
ğŸ“Š Created tables: MatchingRequests, DriverLocations
```

ğŸš€ UYGULAMAYI BAÅLATMA:
-----------------------
1. Terminal'i aÃ§Ä±n ve proje klasÃ¶rÃ¼ne gidin:
```bash
cd c:\Users\emira\Documents\GitHub\TakiWebApi\TakiWebApi
```

2. UygulamayÄ± Ã§alÄ±ÅŸtÄ±rÄ±n:
```bash
dotnet run
```

3. BaÅŸarÄ±lÄ± baÅŸlatma mesajlarÄ±nÄ± kontrol edin:
```
âœ… Database connection successful!
ğŸ“Š Connected to: TaxiDb
ğŸŒ Now listening on: https://localhost:5001
```

===============================================
2. TEMEL KULLANIM SENARYOLARI
===============================================

ğŸ¯ SENARYO 1: YAKINDAKI SÃœRÃœCÃœLERÄ° BULMA
------------------------------------------

**AmaÃ§:** Belirli konumda yakÄ±ndaki mÃ¼sait sÃ¼rÃ¼cÃ¼leri listelemek

**API Endpoint:**
```http
GET /api/matching/nearby-drivers?latitude=41.0082&longitude=28.9784&radius=5.0&maxResults=10&minRating=4.0
Authorization: Bearer {token}
```

**Parametreler:**
- `latitude`: Enlem koordinatÄ± (zorunlu)
- `longitude`: Boylam koordinatÄ± (zorunlu)  
- `radius`: Arama yarÄ±Ã§apÄ± km (varsayÄ±lan: 5.0)
- `maxResults`: Maksimum sonuÃ§ sayÄ±sÄ± (varsayÄ±lan: 10)
- `minRating`: Minimum sÃ¼rÃ¼cÃ¼ puanÄ± (opsiyonel)

**Ã–rnek YanÄ±t:**
```json
[
  {
    "driverID": 1,
    "fullName": "Mehmet YÄ±lmaz",
    "phoneNumber": "+905556789012",
    "vehiclePlate": "34ABC123",
    "vehicleModel": "Toyota Corolla",
    "vehicleColor": "Beyaz",
    "distance": 0.8,
    "averageRating": 4.7,
    "totalRatings": 25,
    "isAvailable": true,
    "estimatedArrival": "3 dakika",
    "latitude": 41.0082,
    "longitude": 28.9784
  }
]
```

**NasÄ±l Test Edilir:**
1. Postman veya VS Code REST Client kullanÄ±n
2. Matching.http dosyasÄ±ndaki "Get nearby drivers" endpoint'ini Ã§alÄ±ÅŸtÄ±rÄ±n
3. KoordinatlarÄ± Ä°stanbul'dan bir nokta olarak ayarlayÄ±n

---

ğŸ¯ SENARYO 2: OTOMATÄ°K EÅLEÅTÄ°RME
----------------------------------

**AmaÃ§:** Yolcu iÃ§in en uygun sÃ¼rÃ¼cÃ¼yÃ¼ otomatik bulup eÅŸleÅŸtirmek

**API Endpoint:**
```http
POST /api/matching/find-best-match
Authorization: Bearer {token}
Content-Type: application/json
```

**Ä°stek GÃ¶vdesi:**
```json
{
    "passengerID": 1,
    "pickupAddress": "BeÅŸiktaÅŸ, Ä°stanbul",
    "dropoffAddress": "ÅiÅŸli, Ä°stanbul",
    "pickupLatitude": 41.0428,
    "pickupLongitude": 29.0094,
    "dropoffLatitude": 41.0611,
    "dropoffLongitude": 28.9847,
    "maxWaitTime": 15.0,
    "minRating": 4.0,
    "maxDistance": 10.0,
    "notes": "Acil deÄŸil, gÃ¼venli sÃ¼rÃ¼cÃ¼ tercihim var"
}
```

**YanÄ±t:**
```json
{
    "matchingRequestID": 123,
    "status": "Pending",
    "driverID": 2,
    "driverName": "Mehmet YÄ±lmaz",
    "vehiclePlate": "34ABC123",
    "driverPhone": "+905556789012",
    "distance": 0.8,
    "estimatedCost": 45.50,
    "estimatedArrival": "3 dakika",
    "requestTime": "2024-10-30T14:30:00Z",
    "message": "En uygun sÃ¼rÃ¼cÃ¼ bulundu ve talep oluÅŸturuldu."
}
```

**AdÄ±m AdÄ±m KullanÄ±m:**
1. Yolcunun konum bilgilerini alÄ±n
2. VarÄ±ÅŸ adresini belirleyin
3. API'yi Ã§aÄŸÄ±rÄ±n
4. DÃ¶nen `matchingRequestID`'yi kaydedin
5. Talep durumunu takip edin

---

ğŸ¯ SENARYO 3: SÃœRÃœCÃœ KONUM GÃœNCELLEMESÄ°
---------------------------------------

**AmaÃ§:** SÃ¼rÃ¼cÃ¼nÃ¼n konumunu ve mÃ¼saitlik durumunu gÃ¼ncellemek

**API Endpoint:**
```http
PUT /api/matching/driver/{driverId}/location
Authorization: Bearer {token}
Content-Type: application/json
```

**Ä°stek GÃ¶vdesi:**
```json
{
    "latitude": 41.0082,
    "longitude": 28.9784,
    "isAvailable": true,
    "currentAddress": "BeÅŸiktaÅŸ Merkez, Ä°stanbul",
    "speed": 25.5,
    "heading": 180.0
}
```

**KullanÄ±m DurumlarÄ±:**
- SÃ¼rÃ¼cÃ¼ uygulamasÄ± aÃ§Ä±ldÄ±ÄŸÄ±nda
- GPS konum deÄŸiÅŸikliklerinde (her 30 saniyede)
- MÃ¼saitlik durumu deÄŸiÅŸikliklerinde
- Yolculuk baÅŸlangÄ±Ã§/bitiÅŸinde

---

ğŸ¯ SENARYO 4: TALEBÄ° KABUL ETME/REDDETME
----------------------------------------

**SÃ¼rÃ¼cÃ¼ Talebi Kabul Eder:**
```http
POST /api/matching/driver/{driverId}/accept/{requestId}
Authorization: Bearer {token}
```

**SÃ¼rÃ¼cÃ¼ Talebi Reddeder:**
```http
POST /api/matching/driver/{driverId}/reject/{requestId}
Authorization: Bearer {token}
```

**YanÄ±t (Kabul):**
```json
{
    "matchingRequestID": 123,
    "status": "Accepted",
    "driverID": 2,
    "requestTime": "2024-10-30T14:30:00Z",
    "acceptedTime": "2024-10-30T14:32:00Z",
    "message": "Talep baÅŸarÄ±yla kabul edildi."
}
```

===============================================
3. ADIM ADIM KULLANIM REHBERÄ°
===============================================

ğŸ“± YOLCU UYGULAMASI Ä°Ã‡Ä°N WORKFLOW:
----------------------------------

**AdÄ±m 1: GiriÅŸ Yap**
```http
POST /api/auth/login
{
    "phoneNumber": "+905551234567",
    "password": "123456"
}
```

**AdÄ±m 2: Konumu Al**
- GPS'den mevcut konum
- Veya kayÄ±tlÄ± adreslerden seÃ§:
```http
GET /api/useraddresses/user/{userId}
```

**AdÄ±m 3: YakÄ±ndaki SÃ¼rÃ¼cÃ¼leri GÃ¶r**
```http
GET /api/matching/nearby-drivers?latitude=41.0082&longitude=28.9784&radius=5.0
```

**AdÄ±m 4: Yolculuk Talebi OluÅŸtur**
```http
POST /api/matching/find-best-match
{
    "passengerID": 1,
    "pickupAddress": "Mevcut konum",
    "dropoffAddress": "Hedef adres",
    ...
}
```

**AdÄ±m 5: Talep Durumunu Ä°zle**
```http
GET /api/matching/request/{requestId}/status
```

**AdÄ±m 6: SÃ¼rÃ¼cÃ¼ Bilgilerini Al**
- Kabul edildikten sonra sÃ¼rÃ¼cÃ¼ detaylarÄ± gÃ¶sterilir

**AdÄ±m 7: Yolculuk TamamlandÄ±ÄŸÄ±nda**
- SÃ¼rÃ¼cÃ¼yÃ¼ deÄŸerlendir
- Ã–demeyi gerÃ§ekleÅŸtir

---

ğŸš— SÃœRÃœCÃœ UYGULAMASI Ä°Ã‡Ä°N WORKFLOW:
-----------------------------------

**AdÄ±m 1: GiriÅŸ Yap**
```http
POST /api/auth/driver-login
{
    "phoneNumber": "+905556789012",
    "password": "driver123"
}
```

**AdÄ±m 2: Ã‡evrimiÃ§i Ol**
```http
PUT /api/matching/driver/{driverId}/availability
true
```

**AdÄ±m 3: Konumu GÃ¼ncelle**
```http
PUT /api/matching/driver/{driverId}/location
{
    "latitude": 41.0082,
    "longitude": 28.9784,
    "isAvailable": true
}
```

**AdÄ±m 4: Gelen Talepleri Kontrol Et**
```http
GET /api/matching/driver/{driverId}/requests
```

**AdÄ±m 5: Talep GeldiÄŸinde Karar Ver**
- Kabul et: `POST /api/matching/driver/{id}/accept/{requestId}`
- Reddet: `POST /api/matching/driver/{id}/reject/{requestId}`

**AdÄ±m 6: Yolculuk SÄ±rasÄ±nda**
- Konumu dÃ¼zenli gÃ¼ncelle
- MÃ¼saitlik durumunu "false" yap

**AdÄ±m 7: Yolculuk Bitiminde**
- MÃ¼saitlik durumunu "true" yap
- Yolcuyu deÄŸerlendir

===============================================
4. GERÃ‡EK ZAMANLI TEST REHBERÄ°
===============================================

ğŸ§ª TEST SENARYOSU 1: TAM EÅLEÅTÄ°RME SÃœRECÄ°
-------------------------------------------

**1. SÃ¼rÃ¼cÃ¼ HazÄ±rlÄ±ÄŸÄ±:**
```http
PUT https://localhost:5001/api/matching/driver/1/location
Authorization: Bearer {token}
Content-Type: application/json

{
    "latitude": 41.0082,
    "longitude": 28.9784,
    "isAvailable": true,
    "currentAddress": "BeÅŸiktaÅŸ Merkez"
}
```

**2. YakÄ±ndaki SÃ¼rÃ¼cÃ¼leri Kontrol:**
```http
GET https://localhost:5001/api/matching/nearby-drivers?latitude=41.0082&longitude=28.9784&radius=5.0
Authorization: Bearer {token}
```

**3. Otomatik EÅŸleÅŸtirme:**
```http
POST https://localhost:5001/api/matching/find-best-match
Authorization: Bearer {token}
Content-Type: application/json

{
    "passengerID": 1,
    "pickupAddress": "BeÅŸiktaÅŸ Ä°skele",
    "dropoffAddress": "KabataÅŸ Vapur Ä°skelesi",
    "pickupLatitude": 41.0428,
    "pickupLongitude": 29.0094,
    "dropoffLatitude": 41.0611,
    "dropoffLongitude": 28.9847,
    "maxWaitTime": 10.0,
    "minRating": 4.0,
    "maxDistance": 5.0
}
```

**4. Talep Durumu KontrolÃ¼:**
```http
GET https://localhost:5001/api/matching/request/{requestId}/status
Authorization: Bearer {token}
```

**5. SÃ¼rÃ¼cÃ¼ Kabul Eder:**
```http
POST https://localhost:5001/api/matching/driver/1/accept/{requestId}
Authorization: Bearer {token}
```

**Beklenen SonuÃ§:** Status "Accepted" olmalÄ± ve sÃ¼rÃ¼cÃ¼ "unavailable" olmalÄ±.

---

ğŸ§ª TEST SENARYOSU 2: Ã‡OKLU SÃœRÃœCÃœ TESTÄ°
---------------------------------------

**1. Birden Fazla SÃ¼rÃ¼cÃ¼yÃ¼ Ã‡evrimiÃ§i Yap:**
```http
# SÃ¼rÃ¼cÃ¼ 1
PUT https://localhost:5001/api/matching/driver/1/location
# SÃ¼rÃ¼cÃ¼ 2  
PUT https://localhost:5001/api/matching/driver/2/location
# SÃ¼rÃ¼cÃ¼ 3
PUT https://localhost:5001/api/matching/driver/3/location
```

**2. YakÄ±ndaki TÃ¼m SÃ¼rÃ¼cÃ¼leri Listele:**
```http
GET https://localhost:5001/api/matching/nearby-drivers?latitude=41.0082&longitude=28.9784&radius=10.0&maxResults=20
```

**3. En Ä°yi EÅŸleÅŸtirmeyi Test Et:**
```http
POST https://localhost:5001/api/matching/find-best-match
```

**Beklenen SonuÃ§:** En yakÄ±n ve en yÃ¼ksek puanlÄ± sÃ¼rÃ¼cÃ¼ seÃ§ilmeli.

===============================================
5. HATA DURULARI VE Ã‡Ã–ZÃœMLERÄ°
===============================================

âŒ YAYGN HATALAR VE Ã‡Ã–ZÃœMLERÄ°:
------------------------------

**Hata 1: "YakÄ±nda mÃ¼sait sÃ¼rÃ¼cÃ¼ bulunamadÄ±"**
```json
{
    "status": "Rejected",
    "message": "YakÄ±nda mÃ¼sait sÃ¼rÃ¼cÃ¼ bulunamadÄ±."
}
```

**Ã‡Ã¶zÃ¼m:**
- Arama yarÄ±Ã§apÄ±nÄ± artÄ±rÄ±n (radius=10.0)
- Minimum rating'i dÃ¼ÅŸÃ¼rÃ¼n
- SÃ¼rÃ¼cÃ¼lerin Ã§evrimiÃ§i olduÄŸunu kontrol edin

**Hata 2: "401 Unauthorized"**
```json
{
    "status": 401,
    "message": "Unauthorized"
}
```

**Ã‡Ã¶zÃ¼m:**
- Token'Ä±n doÄŸru olduÄŸunu kontrol edin
- Token'Ä±n sÃ¼resi dolmuÅŸ olabilir
- Yeniden giriÅŸ yapÄ±n

**Hata 3: "SÃ¼rÃ¼cÃ¼ ÅŸu anda mÃ¼sait deÄŸil"**
```json
{
    "message": "SÃ¼rÃ¼cÃ¼ ÅŸu anda mÃ¼sait deÄŸil."
}
```

**Ã‡Ã¶zÃ¼m:**
- SÃ¼rÃ¼cÃ¼nÃ¼n availability durumunu kontrol edin
- SÃ¼rÃ¼cÃ¼nÃ¼n baÅŸka bir aktif yolculuÄŸu olabilir

**Hata 4: "GeÃ§ersiz koordinat"**
```json
{
    "errors": {
        "latitude": ["The field latitude must be between -90 and 90."]
    }
}
```

**Ã‡Ã¶zÃ¼m:**
- KoordinatlarÄ± kontrol edin (lat: -90 to 90, lng: -180 to 180)
- TÃ¼rkiye iÃ§in yaklaÅŸÄ±k: lat=41.0, lng=29.0

===============================================
6. Ä°STATÄ°STÄ°KLER VE Ä°ZLEME
===============================================

ğŸ“Š SÄ°STEM Ä°STATÄ°STÄ°KLERÄ°:
-------------------------

**Aktif Talep SayÄ±sÄ±:**
```http
GET /api/matching/statistics/active-requests
```

**MÃ¼sait SÃ¼rÃ¼cÃ¼ SayÄ±sÄ±:**
```http
GET /api/matching/statistics/available-drivers  
```

**GÃ¼nlÃ¼k Rapor:**
```http
GET /api/matching/requests/date-range?startDate=2024-10-30&endDate=2024-10-30
```

**TÃ¼m SÃ¼rÃ¼cÃ¼ KonumlarÄ± (Admin):**
```http
GET /api/matching/all-driver-locations
Authorization: Bearer {admin_token}
```

===============================================
7. PERFORMANS OPTÄ°MÄ°ZASYONU
===============================================

âš¡ PERFORMANS Ä°PUÃ‡LARI:
----------------------

**1. Konum GÃ¼ncellemeleri:**
- SÃ¼rÃ¼cÃ¼ konumunu 30 saniyede bir gÃ¼ncelleyin
- HÄ±zlÄ± hareket halindeyken 15 saniyede bir

**2. Arama Optimizasyonu:**
- Radius'u 20km'den fazla yapmayÄ±n
- MaxResults'Ä± 50'den fazla yapmayÄ±n

**3. Cache Stratejisi:**
- YakÄ±ndaki sÃ¼rÃ¼cÃ¼ler 30 saniye cache'lenebilir
- Ä°statistikler 5 dakika cache'lenebilir

**4. Database Maintenance:**
```sql
-- Eski talepleri temizle
EXEC dbo.CleanupExpiredRequests;

-- Ã‡evrimdÄ±ÅŸÄ± sÃ¼rÃ¼cÃ¼leri gÃ¼ncelle  
EXEC dbo.UpdateOfflineDrivers;
```

===============================================
8. GÃœVENLÄ°K VE YETKÄ°LENDÄ°RME
===============================================

ğŸ” GÃœVENLÄ°K KURALLARI:
----------------------

**1. Token KullanÄ±mÄ±:**
- Her istekte Authorization header gerekli
- Token sÃ¼resi: 24 saat
- Refresh token ile yenileyin

**2. Roller ve Ä°zinler:**
- `User`: Yolcu iÅŸlemleri
- `Driver`: SÃ¼rÃ¼cÃ¼ iÅŸlemleri  
- `Admin`: TÃ¼m iÅŸlemler + raporlar

**3. Data Validation:**
- Koordinatlar otomatik validasyona tabi
- Mesafeler ve maliyetler server'da hesaplanÄ±r
- Client'tan gelen veriler gÃ¼venilmez

===============================================
9. SORUN GÄ°DERME REHBERÄ°
===============================================

ğŸ”§ ADIM ADIM SORUN GÄ°DERME:
---------------------------

**1. API Ã‡alÄ±ÅŸmÄ±yor:**
```bash
# UygulamanÄ±n Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± kontrol et
curl https://localhost:5001/api/matching/statistics/available-drivers

# Database baÄŸlantÄ±sÄ±nÄ± test et
dotnet run
```

**2. SÃ¼rÃ¼cÃ¼ GÃ¶rÃ¼nmÃ¼yor:**
```sql
-- Database'de sÃ¼rÃ¼cÃ¼ konumlarÄ±nÄ± kontrol et
SELECT * FROM DriverLocations WHERE IsOnline = 1;
SELECT * FROM vw_AvailableDrivers;
```

**3. EÅŸleÅŸtirme Ã‡alÄ±ÅŸmÄ±yor:**
```http
# Debug iÃ§in adÄ±m adÄ±m test et
GET /api/drivers/active
GET /api/matching/nearby-drivers?lat=41&lng=29&radius=50
```

**4. Performance Problemi:**
```sql
-- Ä°ndeksleri kontrol et
SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID('DriverLocations');
```

===============================================
10. PRODUCTION HAZIRLIK LÄ°STESÄ°
===============================================

âœ… PRODUCTION Ã–NCESÄ° KONTROL:
-----------------------------

**Database:**
- [ ] TÃ¼m tablolar oluÅŸturuldu
- [ ] Ä°ndeksler mevcut
- [ ] Stored procedure'ler Ã§alÄ±ÅŸÄ±yor
- [ ] Sample data temizlendi

**API:**
- [ ] TÃ¼m endpoint'ler test edildi
- [ ] Authorization Ã§alÄ±ÅŸÄ±yor
- [ ] Error handling doÄŸru
- [ ] Logging aktif

**Performance:**
- [ ] Database performance test edildi
- [ ] API response time'larÄ± kontrol edildi
- [ ] Memory usage normal
- [ ] Connection pooling aktif

**Security:**
- [ ] HTTPS aktif
- [ ] JWT secret gÃ¼venli
- [ ] Rate limiting eklendi
- [ ] Input validation tam

===============================================
SONUÃ‡
===============================================

Bu rehberle sÃ¼rÃ¼cÃ¼-kullanÄ±cÄ± eÅŸleÅŸtirme sistemini baÅŸarÄ±yla kullanabilirsiniz!

ğŸ¯ **Ana Ã–zellikler:**
âœ… GerÃ§ek zamanlÄ± konum takibi
âœ… AkÄ±llÄ± mesafe hesaplama  
âœ… Otomatik en iyi eÅŸleÅŸtirme
âœ… Rating bazlÄ± filtreleme
âœ… Dinamik maliyet hesaplama
âœ… Comprehensive API

ğŸ“ **Destek Ä°Ã§in:**
- API dokÃ¼mantasyonu: `/swagger` endpoint'i
- Test dosyalarÄ±: `Matching.http`
- Database: `CreateMatchingTables.sql`

**Ä°yi kullanÄ±mlar!** ğŸš€